<!DOCTYPE html>
<html>
<head>
  <title>Student Data Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .content { max-width: 800px; margin: auto; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 15px; padding: 10px 15px; font-size: 16px; }
    canvas { margin-top: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="content">
    <h1>üìä Student Data Tracker</h1>

    <!-- Login Form -->
    <div id="loginSection">
      <label>Student Name:</label>
      <input type="text" id="loginName">
      <label>Passcode:</label>
      <input type="password" id="loginPasscode">
      <button onclick="login()">üîë Log In</button>
    </div>

    <!-- Tracker Form -->
    <div id="trackerSection" class="hidden">
      <h2>Welcome, <span id="studentDisplay"></span></h2>

      <label>Class:</label>
      <input type="text" id="studentClass">

      <label>Teacher:</label>
      <input type="text" id="teacherName">

      <label>Career Goal:</label>
      <input type="text" id="careerGoal">

      <label>Academic Goal:</label>
      <input type="text" id="academicGoal">

      <h3>Weekly Check-ins</h3>
      <label>Date 1:</label>
      <input type="date" id="checkin1Date">
      <textarea id="checkin1" placeholder="Write your check-in..."></textarea>

      <label>Date 2:</label>
      <input type="date" id="checkin2Date">
      <textarea id="checkin2" placeholder="Write your check-in..."></textarea>

      <label>Date 3:</label>
      <input type="date" id="checkin3Date">
      <textarea id="checkin3" placeholder="Write your check-in..."></textarea>

      <h3>Test Scores</h3>
      <label>Test Name:</label>
      <input type="text" id="testName">
      <label>Score:</label>
      <input type="number" id="testScore">
      <button onclick="addTest()">‚ûï Add Test Score</button>

      <canvas id="scoreChart" width="400" height="200"></canvas>

      <br>
      <button onclick="saveToGoogleSheets()">üíæ Save Progress</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Replace with your Apps Script Web App URL:
    const BASE_URL = "https://script.google.com/macros/s/AKfycbx4hhmDX-3mGa5nR3aGC4Ap5CsQLzGtD-yLcwPPZ84ECutFITXqGGH5K63_2AvVMyab/exec"; 

    let currentName = "";
    let currentPass = "";
    let assessmentData = [];
    let testNames = [];

    // Add test score to chart
    function addTest() {
      const testName = document.getElementById("testName").value;
      const testScore = parseInt(document.getElementById("testScore").value);

      if (testName && !isNaN(testScore)) {
        testNames.push(testName);
        assessmentData.push(testScore);
        updateChart();
      }
    }

    // Draw chart
    function updateChart() {
      const ctx = document.getElementById("scoreChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: testNames,
          datasets: [{
            label: "Test Scores",
            data: assessmentData,
            borderColor: "blue",
            fill: false
          }]
        }
      });
    }

    // Login and load last saved data
    async function login() {
      currentName = document.getElementById("loginName").value.trim();
      currentPass = document.getElementById("loginPasscode").value.trim();

      if (!currentName || !currentPass) {
        alert("Please enter name and passcode.");
        return;
      }

      try {
        const res = await fetch(`${BASE_URL}?name=${encodeURIComponent(currentName)}&passcode=${encodeURIComponent(currentPass)}`);
        const data = await res.json();

        if (data.error) {
          alert("No data found or invalid login. Starting new profile.");
        } else {
          // Prefill fields with last saved data
          document.getElementById("studentClass").value = data.Class || "";
          document.getElementById("teacherName").value = data.Teacher || "";
          document.getElementById("careerGoal").value = data["Career Goal"] || "";
          document.getElementById("academicGoal").value = data["Academic Goal"] || "";

          // Reset test data
          testNames = (data["Test Names"] || "").split(",").map(s => s.trim()).filter(Boolean);
          assessmentData = (data["Test Scores"] || "").split(",").map(s => parseInt(s)).filter(n => !isNaN(n));
          updateChart();
        }

        document.getElementById("studentDisplay").textContent = currentName;
        document.getElementById("loginSection").classList.add("hidden");
        document.getElementById("trackerSection").classList.remove("hidden");

      } catch (err) {
        console.error("Login failed", err);
        alert("‚ùå Could not load data. Try again.");
      }
    }

    // Save current data to Google Sheets
    async function saveToGoogleSheets() {
      const data = {
        studentName: currentName,
        passcode: currentPass,
        studentClass: document.getElementById("studentClass").value,
        teacherName: document.getElementById("teacherName").value,
        careerGoal: document.getElementById("careerGoal").value,
        academicGoal: document.getElementById("academicGoal").value,
        checkins: [
          { date: document.getElementById("checkin1Date").value, text: document.getElementById("checkin1").value },
          { date: document.getElementById("checkin2Date").value, text: document.getElementById("checkin2").value },
          { date: document.getElementById("checkin3Date").value, text: document.getElementById("checkin3").value }
        ],
        testNames: testNames,
        assessmentData: assessmentData
      };

      try {
        const response = await fetch(BASE_URL, {
          method: "POST",
          body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.status === "success") {
          alert("‚úÖ Data saved to Google Sheets!");
        } else {
          alert("‚ö†Ô∏è Error saving data.");
        }
      } catch (error) {
        console.error("Save failed:", error);
        alert("‚ùå Could not save data.");
      }
    }
  </script>
</body>
</html>
