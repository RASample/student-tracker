<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Student Data Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .content { max-width: 800px; margin: auto; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 15px; padding: 10px 15px; font-size: 16px; }
    canvas { margin-top: 20px; }
    .hidden { display: none; }

    /* Busy modal */
    .modal {
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-box {
      background: #fff; color: #111; border-radius: 12px;
      padding: 18px 22px; font-size: 18px;
      box-shadow: 0 10px 40px rgba(0,0,0,.2);
      min-width: 260px; text-align: center;
    }
  </style>

  <!-- Define app logic BEFORE loading the GSI script -->
  <script>
    // ======= CONFIG (REPLACE THESE) =======
    const CLIENT_ID = "46574731783-ubpvvqhsrnftv70ht57ecf2vcj9l0kjc.apps.googleusercontent.com"; 
    const SCRIPT_ID = "AKfycbwHTMHBdbdL5JoFD_yM2F0PX5kqjwjE3I6uC1IqGmKmwLxq0sV0grT9N8dC8pvd3dACRw";           

    // ======= State =======
    let tokenClient;
    let accessToken = null;
    let currentEmail = null;
    let testNames = [];
    let assessmentData = [];
    let chartInstance = null;

    // UX state
    let isDirty = false;  // unsaved changes
    let isSaving = false; // guard double-clicks

    // ======= Modal helpers =======
    function showBusy(text) {
      document.getElementById("busyText").textContent = text || "Workingâ€¦";
      document.getElementById("busyModal").classList.add("show");
    }
    function hideBusy() {
      document.getElementById("busyModal").classList.remove("show");
    }

    // ======= GSI callback (must be global) =======
    window.onSignIn = function (response) {
      console.log("GSI callback:", response);
      document.getElementById("status").innerText = "Signing inâ€¦";
      initTokenClient();
      tokenClient.requestAccessToken();
    };

    function initTokenClient() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email",
        ux_mode: "popup",
        callback: async (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          console.log("Got access token:", accessToken);
          await fetchEmail();
          await loadStudentData();
          document.getElementById("trackerSection").classList.remove("hidden");
          isDirty = false;
        }
      });
    }

    async function fetchEmail() {
      try {
        const res = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
          headers: { "Authorization": `Bearer ${accessToken}` }
        });
        const info = await res.json();
        currentEmail = info.email || null;
        console.log("User info:", info);
        document.getElementById("status").innerText =
          currentEmail ? `Signed in as ${currentEmail}` : "Signed in!";
      } catch (e) {
        console.error("Failed to fetch userinfo:", e);
        document.getElementById("status").innerText = "Signed in (email unavailable)";
      }
    }

    // ======= Execution API helper =======
    async function callScript(functionName, params) {
      if (!accessToken) {
        alert("âš ï¸ Please sign in first.");
        return null;
      }
      const url = `https://script.googleapis.com/v1/scripts/${SCRIPT_ID}:run`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          function: functionName,
          parameters: params,
          devMode: true // run latest code without redeploying
        })
      });

      let data;
      try { data = await res.json(); }
      catch { data = { error: { message: `HTTP ${res.status}` } }; }
      console.log(`[${functionName}] Execution API Response:`, data);
      return data;
    }

    // Pretty-print Apps Script error payloads when present
    function logScriptErrorPayload(resp) {
      const d = resp?.error?.details?.[0];
      if (!d) return;
      console.error("Apps Script error:", d.errorType, d.errorMessage);
      if (d.scriptStackTraceElements) console.table(d.scriptStackTraceElements);
    }

    // ======= Parsing helpers (robust to strings/arrays/numbers) =======
    function toStringArray(val) {
      if (Array.isArray(val)) return val.map(x => (x ?? "").toString()).filter(Boolean);
      if (typeof val === "string") return val.split(",").map(s => s.trim()).filter(Boolean);
      if (val == null) return [];
      return [(val).toString()];
    }
    function toNumberArray(val) {
      if (Array.isArray(val)) return val.map(x => parseFloat(x)).filter(Number.isFinite);
      if (typeof val === "string") return val.split(",").map(s => parseFloat(s)).filter(Number.isFinite);
      if (typeof val === "number") return [val];
      return [];
    }

    // ======= Chart helpers =======
    function updateChart() {
      const ctx = document.getElementById("scoreChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: testNames,
          datasets: [{
            label: "Test Scores",
            data: assessmentData,
            borderColor: "blue",
            fill: false
          }]
        }
      });
    }

    function addTest() {
      const testName = document.getElementById("testName").value;
      const testScore = parseInt(document.getElementById("testScore").value);
      if (testName && !isNaN(testScore)) {
        testNames.push(testName);
        assessmentData.push(testScore);
        isDirty = true;
        updateChart();
      }
    }

    // ======= Load / Save =======
    async function loadStudentData() {
      if (!currentEmail) return;

      const resp = await callScript("getStudentData", [currentEmail]);
      if (resp?.error) { logScriptErrorPayload(resp); console.warn("Load failed: ScriptError"); return; }
      if (resp?.response?.result?.error) { console.warn("No existing data:", resp.response.result.error); return; }

      const data = resp?.response?.result;
      if (!data || typeof data !== "object") { console.warn("Unexpected load payload:", data); return; }

      document.getElementById("studentClass").value  = data.Class || "";
      document.getElementById("teacherName").value   = data.Teacher || "";
      document.getElementById("careerGoal").value    = data["Career Goal"] || "";
      document.getElementById("academicGoal").value  = data["Academic Goal"] || "";

      testNames = toStringArray(data["Test Names"]);
      assessmentData = toNumberArray(data["Test Scores"]);
      updateChart();

      isDirty = false; // after successful load
    }

    async function saveToGoogleSheets() {
      if (!currentEmail) { alert("âš ï¸ Not signed in."); return; }
      if (isSaving) return; // guard

      isSaving = true;
      showBusy("Saving in progressâ€¦");

      const payload = {
        studentClass:  document.getElementById("studentClass").value,
        teacherName:   document.getElementById("teacherName").value,
        careerGoal:    document.getElementById("careerGoal").value,
        academicGoal:  document.getElementById("academicGoal").value,
        checkins: [
          { date: document.getElementById("checkin1Date").value, text: document.getElementById("checkin1").value },
          { date: document.getElementById("checkin2Date").value, text: document.getElementById("checkin2").value },
          { date: document.getElementById("checkin3Date").value, text: document.getElementById("checkin3").value }
        ],
        testNames,
        assessmentData
      };

      try {
        const resp = await callScript("saveStudentData", [currentEmail, payload]);
        if (resp?.error) { logScriptErrorPayload(resp); alert("âš ï¸ Error saving data. Check console."); return; }
        const ok = resp?.response?.result?.status === "success";
        if (ok) {
          isDirty = false;
          alert("âœ… Data saved to Google Sheets!");
        } else {
          const msg = resp?.response?.result?.message || "unknown";
          alert("âš ï¸ Error saving data: " + msg);
        }
      } finally {
        isSaving = false;
        hideBusy();
        if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = "ðŸ’¾ Save Progress"; }
      }
    }

    // ======= Unsaved-change prompt & input listeners =======
    document.addEventListener("DOMContentLoaded", () => {
      // Show a â€œloadingâ€ modal as soon as they click the Google button
      const gbtn = document.querySelector(".g_id_signin");
      if (gbtn) gbtn.addEventListener("click", () => showBusy("Loading your dataâ€¦"));

      // Any input change marks the form as dirty
      document.querySelectorAll("#trackerSection input, #trackerSection textarea").forEach(el => {
        el.addEventListener("input", () => { isDirty = true; });
      });
    });

    window.addEventListener("beforeunload", (e) => {
      if (isDirty && !isSaving) {
        e.preventDefault();
        e.returnValue = ""; // required for Chrome to show prompt
      }
    });
  </script>

  <!-- Load the Google Identity Services library AFTER defining window.onSignIn -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="content">
    <h1>ðŸ“Š Student Data Tracker</h1>

    <!-- Google Sign-in (CLIENT_ID here must match the constant above) -->
    <div id="g_id_onload"
         data-client_id=46574731783-ubpvvqhsrnftv70ht57ecf2vcj9l0kjc.apps.googleusercontent.com"  
         data-context="signin"
         data-ux_mode="popup"
         data-callback="onSignIn"
         data-auto_select="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
    <p id="status">Not signed in</p>

    <!-- Tracker Form -->
    <div id="trackerSection" class="hidden">
      <h2>Welcome! Your progress is tied to your Google account</h2>

      <label>Class:</label>
      <input type="text" id="studentClass">

      <label>Teacher:</label>
      <input type="text" id="teacherName">

      <label>Career Goal:</label>
      <input type="text" id="careerGoal">

      <label>Academic Goal:</label>
      <input type="text" id="academicGoal">

      <h3>Weekly Check-ins</h3>
      <label>Date 1:</label>
      <input type="date" id="checkin1Date">
      <textarea id="checkin1" placeholder="Write your check-in..."></textarea>

      <label>Date 2:</label>
      <input type="date" id="checkin2Date">
      <textarea id="checkin2" placeholder="Write your check-in..."></textarea>

      <label>Date 3:</label>
      <input type="date" id="checkin3Date">
      <textarea id="checkin3" placeholder="Write your check-in..."></textarea>

      <h3>Test Scores</h3>
      <label>Test Name:</label>
      <input type="text" id="testName">
      <label>Score:</label>
      <input type="number" id="testScore">
      <button onclick="addTest()">âž• Add Test Score</button>

      <canvas id="scoreChart" width="400" height="200"></canvas>

      <br>
      <button id="saveBtn" onclick="saveToGoogleSheets()">ðŸ’¾ Save Progress</button>
    </div>
  </div>

  <!-- Busy modal -->
  <div id="busyModal" class="modal">
    <div class="modal-box"><span id="busyText">Workingâ€¦</span></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
