<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Student Data Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .content { max-width: 800px; margin: auto; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 15px; padding: 10px 15px; font-size: 16px; }
    canvas { margin-top: 20px; }
    .hidden { display: none; }
  </style>

  <!-- Define app logic BEFORE loading the GSI script -->
  <script>
    // ======= CONFIG (REPLACE THESE) =======
    const CLIENT_ID = "46574731783-ubpvvqhsrnftv70ht57ecf2vcj9l0kjc.apps.googleusercontent.com"; // <-- replace
    const SCRIPT_ID = "AKfycbwHTMHBdbdL5JoFD_yM2F0PX5kqjwjE3I6uC1IqGmKmwLxq0sV0grT9N8dC8pvd3dACRw";                      // <-- replace (Apps Script Script ID)

    // ======= State =======
    let tokenClient;
    let accessToken = null;
    let currentEmail = null;
    let testNames = [];
    let assessmentData = [];
    let chartInstance = null;

    // ======= GSI callback (must be global) =======
    window.onSignIn = function (response) {
      console.log("GSI callback:", response);
      document.getElementById("status").innerText = "Signing in‚Ä¶";
      initTokenClient();
      tokenClient.requestAccessToken(); // fetch OAuth token after GSI
    };

    function logScriptErrorPayload(resp) {
      const d = resp?.error?.details?.[0];
      if (d) {
        console.error("Apps Script error:", d.errorType, d.errorMessage);
        if (d.scriptStackTraceElements) console.table(d.scriptStackTraceElements);
      }
    }

    function initTokenClient() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email",
        ux_mode: "popup",
        callback: async (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          console.log("Got access token:", accessToken);
          await fetchEmail();
          await loadStudentData();
          document.getElementById("trackerSection").classList.remove("hidden");
        }
      });
    }

    async function fetchEmail() {
      try {
        const res = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
          headers: { "Authorization": `Bearer ${accessToken}` }
        });
        const info = await res.json();
        currentEmail = info.email || null;
        console.log("User info:", info);
        document.getElementById("status").innerText =
          currentEmail ? `Signed in as ${currentEmail}` : "Signed in!";
      } catch (e) {
        console.error("Failed to fetch userinfo:", e);
        document.getElementById("status").innerText = "Signed in (email unavailable)";
      }
    }

    // ======= Execution API helper =======
    async function callScript(functionName, params) {
      if (!accessToken) {
        alert("‚ö†Ô∏è Please sign in first.");
        return null;
      }
      const url = `https://script.googleapis.com/v1/scripts/${SCRIPT_ID}:run`;
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${accessToken}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          function: functionName,
          parameters: params,
          devMode: true
        })
      });

      let data;
      try { data = await res.json(); } catch { data = { error: { message: `HTTP ${res.status}` } }; }
      console.log(`[${functionName}] Execution API Response:`, data);
      return data;
    }

    // Pretty-print Apps Script error payloads when present
    function logScriptErrorPayload(resp) {
      const d = resp?.error?.details?.[0];
      if (!d) return;
      console.error("Apps Script error:", d.errorType, d.errorMessage);
      if (d.scriptStackTraceElements) console.table(d.scriptStackTraceElements);
    }

    // ======= Chart helpers =======
    function updateChart() {
      const ctx = document.getElementById("scoreChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: testNames,
          datasets: [{
            label: "Test Scores",
            data: assessmentData,
            borderColor: "blue",
            fill: false
          }]
        }
      });
    }

    function addTest() {
      const testName = document.getElementById("testName").value;
      const testScore = parseInt(document.getElementById("testScore").value);
      if (testName && !isNaN(testScore)) {
        testNames.push(testName);
        assessmentData.push(testScore);
        updateChart();
      }
    }

    // ======= Load / Save =======
    async function loadStudentData() {
      if (!currentEmail) return;

      const resp = await callScript("getStudentData", [currentEmail]);
      console.log("[getStudentData] Execution API Response:", resp);

      if (resp?.error) {               // transport or thrown Apps Script error
        logScriptErrorPayload(resp);
        console.warn("Load failed: ScriptError");
        return;
      }
      if (resp?.response?.result?.error) {
        console.warn("No existing data:", resp.response.result.error);;
        return;
      }

      const data = resp?.response?.result;
      if (!data || typeof data !== "object") {
        console.warn("Unexpected load payload:", data);
        return;
      }

      document.getElementById("studentClass").value  = data.Class || "";
      document.getElementById("teacherName").value   = data.Teacher || "";
      document.getElementById("careerGoal").value    = data["Career Goal"] || "";
      document.getElementById("academicGoal").value  = data["Academic Goal"] || "";

      testNames = (data["Test Names"] || "").split(",").map(s => s.trim()).filter(Boolean);
      assessmentData = (data["Test Scores"] || "").split(",").map(s => parseFloat(s)).filter(n => Number.isFinite(n));
      updateChart();
    }

    async function saveToGoogleSheets() {
      if (!currentEmail) {
        alert("‚ö†Ô∏è Not signed in.");
        return;
      }
      const payload = {
        studentClass:  document.getElementById("studentClass").value,
        teacherName:   document.getElementById("teacherName").value,
        careerGoal:    document.getElementById("careerGoal").value,
        academicGoal:  document.getElementById("academicGoal").value,
        checkins: [
          { date: document.getElementById("checkin1Date").value, text: document.getElementById("checkin1").value },
          { date: document.getElementById("checkin2Date").value, text: document.getElementById("checkin2").value },
          { date: document.getElementById("checkin3Date").value, text: document.getElementById("checkin3").value }
        ],
        testNames,
        assessmentData
      };

      const resp = await callScript("saveStudentData", [currentEmail, payload]);

      if (resp?.error) {
        logScriptErrorPayload(resp);
        alert("‚ö†Ô∏è Error saving data (script/transport). Check console.");
        return;
      }

      const ok = resp?.response?.result?.status === "success";
      if (ok) {
        alert("‚úÖ Data saved to Google Sheets!");
      } else {
        const msg = resp?.response?.result?.message || "unknown";
        alert("‚ö†Ô∏è Error saving data: " + msg);
      }
    }
  </script>

  <!-- Load the Google Identity Services library AFTER defining window.onSignIn -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="content">
    <h1>üìä Student Data Tracker</h1>

    <!-- Google Sign-in (make sure this CLIENT_ID matches the constant above) -->
    <div id="g_id_onload"
         data-client_id="46574731783-ubpvvqhsrnftv70ht57ecf2vcj9l0kjc.apps.googleusercontent.com"  <!-- <-- replace; must match CLIENT_ID -->
         data-context="signin"
         data-ux_mode="popup"
         data-callback="onSignIn"
         data-auto_select="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
    <p id="status">Not signed in</p>

    <!-- Tracker Form -->
    <div id="trackerSection" class="hidden">
      <h2>Welcome! Your progress is tied to your Google account</h2>

      <label>Class:</label>
      <input type="text" id="studentClass">

      <label>Teacher:</label>
      <input type="text" id="teacherName">

      <label>Career Goal:</label>
      <input type="text" id="careerGoal">

      <label>Academic Goal:</label>
      <input type="text" id="academicGoal">

      <h3>Weekly Check-ins</h3>
      <label>Date 1:</label>
      <input type="date" id="checkin1Date">
      <textarea id="checkin1" placeholder="Write your check-in..."></textarea>

      <label>Date 2:</label>
      <input type="date" id="checkin2Date">
      <textarea id="checkin2" placeholder="Write your check-in..."></textarea>

      <label>Date 3:</label>
      <input type="date" id="checkin3Date">
      <textarea id="checkin3" placeholder="Write your check-in..."></textarea>

      <h3>Test Scores</h3>
      <label>Test Name:</label>
      <input type="text" id="testName">
      <label>Score:</label>
      <input type="number" id="testScore">
      <button onclick="addTest()">‚ûï Add Test Score</button>

      <canvas id="scoreChart" width="400" height="200"></canvas>

      <br>
      <button onclick="saveToGoogleSheets()">üíæ Save Progress</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
