<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š Student Data Tracker</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h1>ğŸ“Š Student Data Tracker</h1>
  <div id="loginDiv"></div>
  <p id="status">Please sign in with Google</p>

  <button onclick="saveData()">ğŸ’¾ Save Progress</button>
  <button onclick="loadData()">ğŸ“‚ Load Progress</button>
  <button onclick="testSave()">ğŸš€ Test Backend Save</button>

  <script>
    const CLIENT_ID = "46574731783-ubpvvqhsrnftv70ht57ecf2vcj9l0kjc.apps.googleusercontent.com"; // your OAuth client ID
    const SCRIPT_ID = "1eJrtJDqiAo_78DtaZ0gV8d3q7i_Zra3EabFoamSuXbTV9Albhv5icBor"; // ğŸ‘ˆ Replace with Apps Script Script ID
    let accessToken = null;

    // Google Sign-in setup
    function initGoogleLogin() {
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse
      });
      google.accounts.id.renderButton(
        document.getElementById("loginDiv"),
        { theme: "outline", size: "large" }
      );
    }

    function handleCredentialResponse(response) {
      const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/spreadsheets",
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById("status").innerText = "âœ… Signed in!";
        }
      });
      tokenClient.requestAccessToken();
    }

    window.onload = initGoogleLogin;

    // Save real student data (dummy values for now)
    async function saveData() {
      const studentObj = {
        studentName: "Demo Student",
        passcode: "1234",
        studentClass: "Math",
        teacherName: "Mr. Smith",
        careerGoal: "Engineer",
        academicGoal: "Graduate with honors",
        checkins: [{ date: "2025-09-13", text: "Started studying" }],
        testNames: ["Quiz 1"],
        assessmentData: [85]
      };

      const url = `https://script.googleapis.com/v1/scripts/${SCRIPT_ID}:run`;
      const body = { function: "doPost", parameters: [studentObj], devMode: true };

      const res = await fetch(url, {
        method: "POST",
        headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      console.log(await res.json());
      alert("Save sent! Check your sheet.");
    }

    // Load data
    async function loadData() {
      const url = `https://script.googleapis.com/v1/scripts/${SCRIPT_ID}:run`;
      const body = { function: "doGet", parameters: [{ name: "Demo Student", passcode: "1234" }], devMode: true };

      const res = await fetch(url, {
        method: "POST",
        headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      console.log(await res.json());
      alert("Load sent! Check console.");
    }

    // ğŸš€ Hardcoded Test Save (backend test)
    async function testSave() {
      const url = `https://script.googleapis.com/v1/scripts/${SCRIPT_ID}:run`;

      const testData = {
        studentName: "Test Student",
        passcode: "0000",
        studentClass: "Science",
        teacherName: "Test Teacher",
        careerGoal: "Astronaut",
        academicGoal: "Ace everything",
        checkins: [{ date: "2025-09-13", text: "This is a test check-in" }],
        testNames: ["Sample Test"],
        assessmentData: [100]
      };

      const body = { function: "doPost", parameters: [testData], devMode: true };

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Authorization": `Bearer ${accessToken}`, "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        console.log(await res.json());
        alert("âœ… Test Save sent, check your Google Sheet!");
      } catch (err) {
        console.error("âŒ Test Save Error:", err);
      }
    }
  </script>
</body>
</html>
